<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†å¡Šä¸Šå‚³æ¸¬è©¦å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 32px;
            font-size: 0.95rem;
        }

        .test-section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 2px solid #e2e8f0;
        }

        .test-section h2 {
            color: #2d3748;
            font-size: 1.2rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .test-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #cbd5e0;
        }

        .test-item.success {
            border-left-color: #48bb78;
        }

        .test-item.error {
            border-left-color: #f56565;
        }

        .test-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .test-desc {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .test-result {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #4a5568;
            background: #edf2f7;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .file-input {
            margin-bottom: 16px;
        }

        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .log {
            background: #1a202c;
            color: #68d391;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .log-line {
            margin: 4px 0;
        }

        .log-error {
            color: #fc8181;
        }

        .log-success {
            color: #68d391;
        }

        .log-info {
            color: #90cdf4;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ§ª åˆ†å¡Šä¸Šå‚³å¯è¡Œæ€§æ¸¬è©¦</h1>
        <p class="subtitle">åœ¨éƒ¨ç½²å‰é©—è­‰æ–¹æ¡ˆæ˜¯å¦å¯è¡Œ</p>

        <!-- æ¸¬è©¦ 1: å‰ç«¯ä»£ç¢¼æª¢æŸ¥ -->
        <div class="test-section">
            <h2>
                <span>1ï¸âƒ£ å‰ç«¯ä»£ç¢¼æª¢æŸ¥</span>
                <span class="status pending" id="status-1">å¾…æ¸¬è©¦</span>
            </h2>
            <div id="test-1-results"></div>
            <button class="btn" onclick="runTest1()">é–‹å§‹æ¸¬è©¦</button>
        </div>

        <!-- æ¸¬è©¦ 2: æª”æ¡ˆåˆ†å¡Šæ¨¡æ“¬ -->
        <div class="test-section">
            <h2>
                <span>2ï¸âƒ£ æª”æ¡ˆåˆ†å¡Šæ¨¡æ“¬</span>
                <span class="status pending" id="status-2">å¾…æ¸¬è©¦</span>
            </h2>
            <div class="file-input">
                <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500;">
                    é¸æ“‡æ¸¬è©¦æª”æ¡ˆï¼ˆä»»æ„æª”æ¡ˆï¼‰ï¼š
                </label>
                <input type="file" id="test-file" style="padding: 8px;">
            </div>
            <div id="test-2-results"></div>
            <button class="btn" onclick="runTest2()">æ¸¬è©¦åˆ†å¡Š</button>
        </div>

        <!-- æ¸¬è©¦ 3: Worker é€£ç·šæ¸¬è©¦ -->
        <div class="test-section">
            <h2>
                <span>3ï¸âƒ£ Worker é€£ç·šæ¸¬è©¦</span>
                <span class="status pending" id="status-3">å¾…æ¸¬è©¦</span>
            </h2>
            <div id="test-3-results"></div>
            <button class="btn" onclick="runTest3()">æ¸¬è©¦é€£ç·š</button>
        </div>

        <!-- æ¸¬è©¦ 4: å®Œæ•´æµç¨‹æ¨¡æ“¬ -->
        <div class="test-section">
            <h2>
                <span>4ï¸âƒ£ å®Œæ•´æµç¨‹æ¨¡æ“¬</span>
                <span class="status pending" id="status-4">å¾…æ¸¬è©¦</span>
            </h2>
            <div id="test-4-results"></div>
            <button class="btn" onclick="runTest4()">æ¨¡æ“¬ä¸Šå‚³</button>
        </div>

        <!-- æ—¥èªŒ -->
        <div class="log" id="log"></div>
    </div>

    <script src="js/config.js"></script>
    <script>
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('log');
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        const setStatus = (testNum, status) => {
            const statusEl = document.getElementById(`status-${testNum}`);
            statusEl.className = `status ${status}`;
            statusEl.textContent = status === 'success' ? 'âœ“ é€šé' : status === 'error' ? 'âœ— å¤±æ•—' : 'å¾…æ¸¬è©¦';
        };

        const addResult = (testNum, name, desc, result, success = true) => {
            const resultsDiv = document.getElementById(`test-${testNum}-results`);
            const item = document.createElement('div');
            item.className = `test-item ${success ? 'success' : 'error'}`;
            item.innerHTML = `
                <div class="test-name">${success ? 'âœ“' : 'âœ—'} ${name}</div>
                <div class="test-desc">${desc}</div>
                ${result ? `<div class="test-result">${result}</div>` : ''}
            `;
            resultsDiv.appendChild(item);
        };

        // æ¸¬è©¦ 1: æª¢æŸ¥å‰ç«¯ä»£ç¢¼
        async function runTest1() {
            log('é–‹å§‹æ¸¬è©¦ 1: å‰ç«¯ä»£ç¢¼æª¢æŸ¥', 'info');
            document.getElementById('test-1-results').innerHTML = '';

            try {
                // æª¢æŸ¥ SWFAPI æ˜¯å¦å­˜åœ¨
                if (typeof SWFAPI !== 'undefined') {
                    addResult(1, 'SWFAPI ç‰©ä»¶', 'æª¢æŸ¥ SWFAPI æ˜¯å¦å·²å®šç¾©', 'typeof SWFAPI = ' + typeof SWFAPI, true);
                    log('âœ“ SWFAPI ç‰©ä»¶å·²å®šç¾©', 'success');
                } else {
                    addResult(1, 'SWFAPI ç‰©ä»¶', 'æª¢æŸ¥ SWFAPI æ˜¯å¦å·²å®šç¾©', 'SWFAPI æœªå®šç¾©ï¼', false);
                    log('âœ— SWFAPI ç‰©ä»¶æœªå®šç¾©', 'error');
                    setStatus(1, 'error');
                    return;
                }

                // æª¢æŸ¥å¿…è¦çš„æ–¹æ³•
                const methods = ['uploadFile', 'uploadSmallFile', 'uploadLargeFile', 'deleteFile'];
                let allMethodsExist = true;

                for (const method of methods) {
                    if (typeof SWFAPI[method] === 'function') {
                        addResult(1, `SWFAPI.${method}()`, `æª¢æŸ¥æ–¹æ³•æ˜¯å¦å­˜åœ¨`, 'typeof = function', true);
                        log(`âœ“ SWFAPI.${method}() å­˜åœ¨`, 'success');
                    } else {
                        addResult(1, `SWFAPI.${method}()`, `æª¢æŸ¥æ–¹æ³•æ˜¯å¦å­˜åœ¨`, 'æ–¹æ³•ä¸å­˜åœ¨ï¼', false);
                        log(`âœ— SWFAPI.${method}() ä¸å­˜åœ¨`, 'error');
                        allMethodsExist = false;
                    }
                }

                // æª¢æŸ¥ SWF_API_URL
                if (typeof SWF_API_URL !== 'undefined') {
                    addResult(1, 'SWF_API_URL', 'Worker URL é…ç½®', SWF_API_URL, true);
                    log('âœ“ Worker URL å·²é…ç½®: ' + SWF_API_URL, 'success');
                } else {
                    addResult(1, 'SWF_API_URL', 'Worker URL é…ç½®', 'URL æœªå®šç¾©ï¼', false);
                    log('âœ— Worker URL æœªå®šç¾©', 'error');
                    allMethodsExist = false;
                }

                setStatus(1, allMethodsExist ? 'success' : 'error');
                log(allMethodsExist ? 'æ¸¬è©¦ 1 å®Œæˆï¼šå…¨éƒ¨é€šé âœ“' : 'æ¸¬è©¦ 1 å®Œæˆï¼šæœ‰éŒ¯èª¤ âœ—', allMethodsExist ? 'success' : 'error');

            } catch (error) {
                addResult(1, 'éŒ¯èª¤', error.message, error.stack, false);
                log('âœ— æ¸¬è©¦ 1 ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
                setStatus(1, 'error');
            }
        }

        // æ¸¬è©¦ 2: æª”æ¡ˆåˆ†å¡Šæ¨¡æ“¬
        async function runTest2() {
            log('é–‹å§‹æ¸¬è©¦ 2: æª”æ¡ˆåˆ†å¡Šæ¨¡æ“¬', 'info');
            document.getElementById('test-2-results').innerHTML = '';

            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];

            if (!file) {
                addResult(2, 'æª”æ¡ˆé¸æ“‡', 'è«‹å…ˆé¸æ“‡ä¸€å€‹æ¸¬è©¦æª”æ¡ˆ', '', false);
                log('âœ— è«‹å…ˆé¸æ“‡æª”æ¡ˆ', 'error');
                setStatus(2, 'error');
                return;
            }

            try {
                const CHUNK_SIZE = 8 * 1024 * 1024; // 8MB
                const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

                addResult(2, 'æª”æ¡ˆè³‡è¨Š', 'æª”æ¡ˆåç¨±å’Œå¤§å°',
                    `åç¨±: ${file.name}\nå¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`, true);
                log(`æª”æ¡ˆ: ${file.name}, å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`, 'info');

                addResult(2, 'åˆ†å¡Šè¨ˆç®—', 'è¨ˆç®—éœ€è¦å¤šå°‘å¡Š',
                    `ç¸½å…±éœ€è¦ ${totalChunks} å¡Š (æ¯å¡Š 8MB)`, true);
                log(`éœ€è¦åˆ†æˆ ${totalChunks} å¡Š`, 'info');

                // æ¨¡æ“¬åˆ†å¡Š
                for (let i = 0; i < Math.min(totalChunks, 3); i++) {
                    const start = i * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, file.size);
                    const chunk = file.slice(start, end);

                    addResult(2, `åˆ†å¡Š ${i + 1}`, `æ¨¡æ“¬åˆ‡å‰²æª”æ¡ˆ`,
                        `èµ·å§‹: ${(start / 1024 / 1024).toFixed(2)} MB\nçµæŸ: ${(end / 1024 / 1024).toFixed(2)} MB\nå¤§å°: ${(chunk.size / 1024 / 1024).toFixed(2)} MB`, true);
                    log(`âœ“ åˆ†å¡Š ${i + 1}: ${(chunk.size / 1024 / 1024).toFixed(2)} MB`, 'success');
                }

                if (totalChunks > 3) {
                    addResult(2, 'æ›´å¤šåˆ†å¡Š', `é‚„æœ‰ ${totalChunks - 3} å€‹åˆ†å¡Š...`, '', true);
                }

                setStatus(2, 'success');
                log('æ¸¬è©¦ 2 å®Œæˆï¼šåˆ†å¡Šæ¨¡æ“¬æˆåŠŸ âœ“', 'success');

            } catch (error) {
                addResult(2, 'éŒ¯èª¤', error.message, error.stack, false);
                log('âœ— æ¸¬è©¦ 2 ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
                setStatus(2, 'error');
            }
        }

        // æ¸¬è©¦ 3: Worker é€£ç·šæ¸¬è©¦
        async function runTest3() {
            log('é–‹å§‹æ¸¬è©¦ 3: Worker é€£ç·šæ¸¬è©¦', 'info');
            document.getElementById('test-3-results').innerHTML = '';

            try {
                // æ¸¬è©¦ Worker æ˜¯å¦å¯è¨ªå•
                log('å˜—è©¦é€£ç·šåˆ°: ' + SWF_API_URL, 'info');

                const response = await fetch(SWF_API_URL, {
                    method: 'GET',
                    mode: 'cors'
                });

                addResult(3, 'Worker é€£ç·š', 'æ¸¬è©¦ Worker æ˜¯å¦å¯è¨ªå•',
                    `ç‹€æ…‹ç¢¼: ${response.status}\nURL: ${SWF_API_URL}`, response.ok);

                if (response.ok) {
                    log('âœ“ Worker é€£ç·šæˆåŠŸ', 'success');
                    setStatus(3, 'success');
                } else {
                    log('âœ— Worker å›æ‡‰ç•°å¸¸: ' + response.status, 'error');
                    setStatus(3, 'error');
                }

                // æ¸¬è©¦ CORS
                const corsHeaders = response.headers.get('access-control-allow-origin');
                addResult(3, 'CORS è¨­å®š', 'æª¢æŸ¥è·¨åŸŸè¨­å®š',
                    `Access-Control-Allow-Origin: ${corsHeaders || 'æœªè¨­å®š'}`, !!corsHeaders);

            } catch (error) {
                addResult(3, 'Worker é€£ç·š', 'æ¸¬è©¦ Worker æ˜¯å¦å¯è¨ªå•',
                    `éŒ¯èª¤: ${error.message}\n\né€™æ˜¯æ­£å¸¸çš„ï¼Worker å¯èƒ½é‚„æ²’éƒ¨ç½²æˆ–éœ€è¦æ›´æ–°`, false);
                log('âš ï¸ Worker é€£ç·šå¤±æ•—ï¼ˆé€™æ˜¯æ­£å¸¸çš„ï¼ŒWorker é‚„æ²’æ›´æ–°ï¼‰', 'info');
                setStatus(3, 'pending');
            }
        }

        // æ¸¬è©¦ 4: å®Œæ•´æµç¨‹æ¨¡æ“¬
        async function runTest4() {
            log('é–‹å§‹æ¸¬è©¦ 4: å®Œæ•´æµç¨‹æ¨¡æ“¬', 'info');
            document.getElementById('test-4-results').innerHTML = '';

            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];

            if (!file) {
                addResult(4, 'æª”æ¡ˆé¸æ“‡', 'è«‹å…ˆé¸æ“‡ä¸€å€‹æ¸¬è©¦æª”æ¡ˆ', '', false);
                log('âœ— è«‹å…ˆé¸æ“‡æª”æ¡ˆ', 'error');
                setStatus(4, 'error');
                return;
            }

            try {
                log('æ¨¡æ“¬ä¸Šå‚³æµç¨‹...', 'info');

                // æ¨¡æ“¬é€²åº¦å›èª¿
                let lastProgress = 0;
                const progressCallback = (progress) => {
                    if (progress !== lastProgress) {
                        log(`é€²åº¦: ${progress}%`, 'info');
                        lastProgress = progress;
                    }
                };

                addResult(4, 'æµç¨‹é–‹å§‹', 'æº–å‚™ä¸Šå‚³æª”æ¡ˆ',
                    `æª”æ¡ˆ: ${file.name}\nå¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`, true);

                // åˆ¤æ–·ä¸Šå‚³æ–¹å¼
                const CHUNK_SIZE = 8 * 1024 * 1024;
                const uploadType = file.size <= CHUNK_SIZE ? 'ç›´æ¥ä¸Šå‚³' : 'åˆ†å¡Šä¸Šå‚³';

                addResult(4, 'ä¸Šå‚³æ–¹å¼', 'æ ¹æ“šæª”æ¡ˆå¤§å°é¸æ“‡',
                    `é¸æ“‡: ${uploadType}\nåŸå› : æª”æ¡ˆ${file.size <= CHUNK_SIZE ? 'â‰¤' : '>'} 8MB`, true);
                log(`é¸æ“‡ä¸Šå‚³æ–¹å¼: ${uploadType}`, 'info');

                if (file.size > CHUNK_SIZE) {
                    const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
                    addResult(4, 'åˆ†å¡Šè³‡è¨Š', 'è¨ˆç®—åˆ†å¡Šæ•¸é‡',
                        `ç¸½å¡Šæ•¸: ${totalChunks}\næ¯å¡Šå¤§å°: 8MB\næœ€å¾Œä¸€å¡Š: ${((file.size % CHUNK_SIZE) / 1024 / 1024).toFixed(2)} MB`, true);
                }

                addResult(4, 'æ¨¡æ“¬çµæœ', 'å®Œæ•´æµç¨‹é©—è­‰',
                    `âœ“ å‰ç«¯ä»£ç¢¼æ­£å¸¸\nâœ“ åˆ†å¡Šé‚è¼¯æ­£ç¢º\nâœ“ é€²åº¦å›èª¿å¯ç”¨\n\nâš ï¸ å¯¦éš›ä¸Šå‚³éœ€è¦å…ˆéƒ¨ç½² Worker`, true);

                setStatus(4, 'success');
                log('æ¸¬è©¦ 4 å®Œæˆï¼šæµç¨‹æ¨¡æ“¬æˆåŠŸ âœ“', 'success');
                log('', 'info');
                log('========================================', 'info');
                log('âœ… æ‰€æœ‰æœ¬åœ°æ¸¬è©¦é€šéï¼', 'success');
                log('ğŸ“ ä¸‹ä¸€æ­¥ï¼šéƒ¨ç½² Cloudflare Worker', 'info');
                log('========================================', 'info');

            } catch (error) {
                addResult(4, 'éŒ¯èª¤', error.message, error.stack, false);
                log('âœ— æ¸¬è©¦ 4 ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
                setStatus(4, 'error');
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œæ¸¬è©¦ 1
        window.addEventListener('load', () => {
            log('æ¸¬è©¦å·¥å…·å·²è¼‰å…¥', 'success');
            log('é»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦...', 'info');
        });
    </script>
</body>

</html>