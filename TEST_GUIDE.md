# 大檔案上傳功能測試指南

## ✅ 已完成的改動

### 1. 前端改動（`js/config.js`）
- ✅ 新增 `SWFAPI` 物件
- ✅ 實作 `uploadFile()` - 自動判斷檔案大小
- ✅ 實作 `uploadSmallFile()` - 處理 ≤8MB 的檔案
- ✅ 實作 `uploadLargeFile()` - 處理 >8MB 的檔案（分塊上傳）
- ✅ 加入進度回調功能

### 2. 後端 Worker（`cloudflare-worker.js`）
- ✅ 新增 `/upload-chunk` 端點 - 接收分塊
- ✅ 實作分塊合併邏輯
- ✅ 支援原有的 `/upload` 端點（小檔案）

### 3. UI 改動（`admin.html`）
- ✅ 單一檔案上傳顯示實際進度
- ✅ 資料夾上傳顯示實際進度
- ✅ 進度條同步更新按鈕文字

## 🧪 測試步驟

### 測試前準備

1. **更新 Cloudflare Worker**
   ```bash
   # 複製 cloudflare-worker.js 的內容
   # 貼到 Cloudflare Dashboard > Workers > swf-api > Edit Code
   # 點擊 Save and Deploy
   ```

2. **確認環境變數**
   - `GITLAB_TOKEN` ✓
   - `GITLAB_PROJECT_ID` ✓
   - `GITLAB_BRANCH` ✓

### 測試案例

#### 測試 1: 小檔案上傳（<8MB）
1. 開啟 `admin.html`
2. 登入後台
3. 選擇一個 <8MB 的 SWF 檔案
4. 點擊「新增作品」
5. **預期結果**：
   - 進度條快速跳到 50% → 100%
   - 按鈕顯示「上傳中... 50%」→「上傳中... 100%」
   - 成功提示「✅ 上傳成功！」

#### 測試 2: 大檔案上傳（>8MB）
1. 選擇一個 >8MB 的 SWF 檔案（例如 15MB）
2. 點擊「新增作品」
3. **預期結果**：
   - Console 顯示：`📦 開始分塊上傳: filename.swf (2 塊)`
   - 進度條逐步增加：0% → 50% → 100%
   - Console 顯示：`✅ 已上傳 1/2 塊`、`✅ 已上傳 2/2 塊`
   - 按鈕顯示「上傳中... 50%」→「上傳中... 100%」
   - 成功提示「✅ 上傳成功！」

#### 測試 3: 超大檔案（>10MB）
1. 選擇一個 >10MB 的 SWF 檔案（例如 20MB）
2. 點擊「新增作品」
3. **預期結果**：
   - Console 顯示：`📦 開始分塊上傳: filename.swf (3 塊)`
   - 進度條平滑增加：0% → 33% → 66% → 100%
   - 所有分塊成功上傳
   - 檔案可以正常播放

#### 測試 4: 資料夾上傳
1. 選擇「資料夾（含多個檔案）」
2. 選擇一個包含 SWF 和資源檔案的資料夾
3. 點擊「新增作品」
4. **預期結果**：
   - 每個檔案上傳時顯示進度
   - 總進度條平滑增加
   - 按鈕顯示總體進度百分比
   - 所有檔案成功上傳

## 🔍 除錯檢查清單

### 如果上傳失敗

1. **檢查瀏覽器 Console**
   ```javascript
   // 應該看到類似的訊息：
   📦 開始分塊上傳: 1234567890_file.swf (2 塊)
   ✅ 已上傳 1/2 塊
   ✅ 已上傳 2/2 塊
   ✅ 所有分塊上傳完成
   ```

2. **檢查 Network 面板**
   - 應該看到多個 `POST /upload-chunk` 請求
   - 每個請求的 Response 應該是 `{"success": true, ...}`

3. **檢查 Worker 日誌**
   - 登入 Cloudflare Dashboard
   - Workers > swf-api > Logs
   - 查看是否有錯誤訊息

### 常見問題

**Q: 進度條卡在某個百分比不動**
- A: 檢查網路連線，可能是某個分塊上傳失敗

**Q: 顯示「上傳失敗: 第 X 塊上傳失敗」**
- A: 檢查 Worker 環境變數是否正確設定

**Q: 檔案上傳成功但無法播放**
- A: 檢查檔案是否完整合併，可以直接訪問檔案 URL 測試

**Q: Worker 回應 500 錯誤**
- A: 可能是 GitLab Token 權限不足或專案 ID 錯誤

## 📊 效能指標

| 檔案大小 | 分塊數量 | 預估時間 |
|---------|---------|---------|
| 5MB     | 1 塊    | 5-10 秒 |
| 10MB    | 2 塊    | 10-20 秒 |
| 20MB    | 3 塊    | 20-30 秒 |
| 50MB    | 7 塊    | 50-70 秒 |

*實際時間取決於網路速度和 GitLab API 回應時間*

## ✨ 下一步優化（可選）

1. **斷點續傳**：儲存已上傳的分塊，網路中斷後可繼續
2. **並行上傳**：同時上傳多個分塊，加快速度
3. **壓縮上傳**：在上傳前壓縮檔案，減少傳輸時間
4. **使用 R2**：改用 Cloudflare R2 儲存，無檔案大小限制
